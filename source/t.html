<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>test</title>
</head>
<body>
<h1>Test</h1>

<t-1>
<t-2></t-2>
<t-2>
<t-3></t-3>
</t-2>
</t-1>

<script type="module">
let t1count = 0;
let t2count = 0;
let t3count = 0;

class T1 extends HTMLElement {
get template () {return _template(this, 2);} // get template

constructor () {
super ();
t1count += 1;
this.id = `t-1-${t1count}`;
} // constructor

connectedCallback () {
createDom.call(this);
childrenReady(this)
.then((children) => console.log(`${children.length} Ready.`));
} // connectedCallback
} // class T1

class T2 extends T1 {
get template () {return _template(this, 3);} // get template

constructor () {
super();
t2count += 1;
this.id = `t-2-${t2count}`;
} // constructor

connectedCallback () {
createDom.call(this);
} // connectedCallback
} // class T2

class T3 extends T1 {
get template () {return _template(this, 4);} // get template

constructor () {
super();
t3count += 1;
this.id = `t-3-${t3count}`;
} // constructor

connectedCallback () {
createDom.call(this);
} // connectedCallback
} // class T3

customElements.define("t-1", T1);
customElements.define("t-2", T2);
customElements.define("t-3", T3);

function elementReady (e, bubbles = true) {
return e.dispatchEvent(new CustomEvent("elementReady", {detail: e, bubbles: bubbles, composed: true}));
} // elementReady



function childrenReady (element) {
const slot = element.shadowRoot.querySelector("slot");
if (!slot) return Promise.resolve(null);

return new Promise((resolve, reject) => {
slot.addEventListener("slotchange", e => {
const children = slot.assignedNodes().filter(e => e.nodeType === 1);
console.log(`childrenReady: ${element.id} has ${children.length} children`);
resolve(Promise.all(children.map(child => childrenReady(child))));
}); // slotchange
}); // promise
} // childrenReady

function waitForChildren () {

} // waitforChildren

function createDom () {
const root = this.attachShadow({mode: "open"});
root.innerHTML = this.template;
} // createDom

function _template (element, level) {
return `
<div class="${element.id}">
<h${level}>${element.id}</h${level}>
<div class="message" aria-live="polite"></div>
</div>

${(level < 4)? "<slot></slot>" : ""}
`;
} // _template

</script>

</body>
</html>
