<!--<link rel="import" href="../polymer/lib/elements/dom-if.html">-->
<!--<link rel="import" href="../polymer/lib/elements/dom-repeat.html">-->

<dom-module id="audio-reverb">
<template>
<style>
:host {
display: block;
}

:host .field {
display: inline;
}
</style>

<div class="audio-reverb" role="region" aria-label$="{{label}}">
<div class="row">
<span class="label">[[label]]</span>

<ui-boolean name="bypass" label="bypass" value="{{bypass}}"></ui-boolean>

</div><!-- .row -->

</div>
</template>

<script>
// audio-reverb
"use strict";

(function () {
var instanceCount  = 0;

class AudioReverb extends _AudioContext_ {
static get is() { return "audio-reverb"; }

static get properties () {
return {
label: {
type: String,
value: ""
}, // label

impulseUrl: {
type: String,
value: "",
notify: true,
observer: "impulseUrlChanged"
}, // impulseUrl

/*impulse: {
type: ArrayBuffer,
value: null,
notify: true,
observer: "impulseChanged"
}, // impulse
*/
bypass: {
type: Boolean,
value: false,
notify: true,
observer: "_bypass"
}, // bypass

invertPhase: {
type: Boolean,
value: false,
notify: true,
observer: "_invertPhase"
} // invertPhase

}; // return
} // get properties

constructor () {
super ();
instanceCount += 1;
this._id = AudioReverb.is + instanceCount;
if (this.__debug()) this.label = this._id;
console.log (`creating ${this._id}`);

this._init (audio.createConvolver());
//this._audioIn.channelCount = this._in.channelCount = this._audioOut.channelCount = this._out.channelCount = this._audioNode.channelCount = 2;
//this._audioIn.channelCountMode = this._in.channelCountMode = this._audioOut.channelCountMode = this._out.channelCountMode = this._audioNode.channelCountMode = "explicit";
} // constructor


connectedCallback () {
super.connectedCallback ();
if (this.contextCheck(AudioReverb.is)) {
this.addFieldLabels ();
} // if
} // connectedCallback

impulseUrlChanged (value) {
console.log (`impulseUrlChanged: ${value}`);
loadImpulse (value, function (buffer) {
console.log ("- loaded...");
this.impulse = buffer;
this._audioNode.buffer = buffer;
}); // load
} // impulseUrlChanged

impulseChanged (buffer) {
console.log (`impulseChanged: ${buffer.size}`);
this._audioNode.buffer = buffer;
} // impulseChanged


} // class AudioReverb


function decodeBuffer(arrayBuffer, callback) {
audio.decodeAudioData(arrayBuffer, function (audioBuffer) {
console.log("Finished decoding audio data.");
if (typeof callback === "function" && audioBuffer !== null) {
callback(audioBuffer);
} else {
throw new Error ("loadImpulse: missing callback");
} // if
}, function (e) {
throw new Error(`Could not decode audio data: ${e}`);
}); // decode
} // decodeBuffer

function loadImpulse (url, callback) {
var request = new XMLHttpRequest();
//request.responseType = "text/plain";
request.open("GET", url, true);
console.log (`requesting ${url}...`);

request.addEventListener("load", function () {
//request.onreadystatechange = function () {
//if (request.readyState === 4 && request.status === 200) {
console.log ("- loaded...");
if (request.response) {
decodeBuffer(toByteArray(request.response), callback);
} else {
throw new Error ("loadImpulse: response is null");
} // if
//} // if
//}; // onreadstatechange
}); // load
request.send();
} // loadImpulse

function base64ToArrayBuffer(input) {
function encodedValue(input, index) {
var encodedCharacter, x = input.charCodeAt(index);
if (index < input.length) {
if (x >= 65 && x <= 90) {
encodedCharacter = x - 65;
} else if (x >= 97 && x <= 122) {
encodedCharacter = x - 71;
} else if (x >= 48 && x <= 57) {
encodedCharacter = x + 4;
} else if (x === 43) {
encodedCharacter = 62;
} else if (x === 47) {
encodedCharacter = 63;
} else if (x !== 61) {
console.log('base64 encountered unexpected character code: ' + x);
}
}
return encodedCharacter;
}

if (input.length === 0 || (input.length % 4) > 0) {
console.log('base64 encountered unexpected length: ' + input.length);
return;
}

var padding = input.match(/[=]*$/)[0].length,
decodedLength = input.length * 3 / 4 - padding,
buffer = new ArrayBuffer(decodedLength),
bufferView = new Uint8Array(buffer),
encoded = [],
d = 0,
e = 0,
i;

while (d < decodedLength) {
for (i = 0; i < 4; i += 1) {
encoded[i] = encodedValue(input, e);
e += 1;
}
bufferView[d] = (encoded[0] * 4) + Math.floor(encoded[1] / 16);
d += 1;
if (d < decodedLength) {
bufferView[d] = ((encoded[1] % 16) * 16) + Math.floor(encoded[2] / 4);
d += 1;
}
if (d < decodedLength) {
bufferView[d] = ((encoded[2] % 4) * 64) + encoded[3];
d += 1;
}
}
return buffer;
} // decodeBase64ToArrayBuffer

window.customElements.define(AudioReverb.is, AudioReverb);
})();
</script>
</dom-module>
