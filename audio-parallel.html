<link rel="import" href="/styles.html">
<!--<link rel="import" href="../polymer/lib/elements/dom-if.html">-->
<!--<link rel="import" href="../polymer/lib/elements/dom-repeat.html">-->

<dom-module id="audio-parallel">
<template>
<style include=audio-component-styles">
</style>

<div class="audio-parallel" role="region" aria-label$="{{label}}">
<span class="label">{{label}}</span>

<div class="field" data-name="bypass">
<label>bypass</label>
<br><input type="checkbox" checked="{{bypass::change}}" accesskey="x">
</div>

<slot on-slotchange="handleSlotChange"></slot>
</div>

</template>

<script>
// audio-parallel
"use strict";

(function () {
var instanceCount = 0;

class AudioParallel extends _AudioContext_ {
static get is() { return "audio-parallel"; }

static get properties () {
return {
label: {
type: String,
value: ""
}, // label

bypass: {
type: Boolean,
value: false,
notify: true,
observer: "_bypass"
}, // bypass
}; // return
} // get properties

constructor () {
super ();
instanceCount += 1;
this._id = AudioParallel.is + instanceCount;

this._init ();
} // constructor

connectedCallback () {
super.connectedCallback ();

if (this.firstElementChild.localName !== "dom-repeat") {
console.log ("direct children so loading now");
this.whenAllChildrenLoaded (this.connectAll);
} else {
console.log ("dom-repeat found so deferring...");
} // if
this.addFieldLabels ();
} // connectedCallback

connectAll (nodes) {
//console.log(`${this.label}: connecting all ${nodes.length} nodes`);

for (var i=0; i<nodes.length; i++) {
let e = nodes[i];
if (e.localName === "dom-repeat") continue;
//console.log(`${this.label}: connecting ${e.label} in parallel`);
this._audioIn.connect (e._in);
e._out.connect (this._audioOut);
} // for

this._audioOut.gain.value = 1/nodes.length;
} // connectAll

/*ready() {
super.ready();
setTimeout(function() {
console.log ("distributed nodes for parallel");
var distributedNodes = this.$.slot.assignedNodes({flatten: true});
console.log(distributedNodes);
}.bind(this), 0);
} // ready
*/

handleSlotChange (e) {
let children = e.target.assignedNodes({flatten:true}).filter(e => e.nodeType===1);
this.dispatchEvent (new CustomEvent("change", {composed: true, bubbles: true, detail: children}));
this.connectAll (children);
} // handleSlotchange


} // class AudioParallel

window.customElements.define(AudioParallel.is, AudioParallel);
})(); // module
</script>
</dom-module>
